<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pitch visualiser – Praat PitchTier + dual audio (vanilla SVG)</title>
  <style>
    :root{--bg:#0b0c0f;--ink:#e7e9ee;--muted:#9aa3b2;--panel:#14161a;--accent:#6ae2ff;--danger:#ff6b6b}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .h1{font-weight:700;font-size:26px;margin:0 0 6px}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px 18px;box-shadow:0 12px 28px rgba(0,0,0,.25)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}
    input[type=number], input[type=range]{background:#0f1218;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:10px;padding:8px 10px}
    input[type=range]{width:100%}
    button{background:#0f1218;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:999px;padding:8px 14px;cursor:pointer}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1218;border:1px solid rgba(255,255,255,.12);font-size:12px;color:var(--muted)}
    svg{display:block;width:100%;height:380px}
    .axis text{font-size:12px;fill:var(--muted)}
    .axis line{stroke:#2a2e36}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">Interactive PitchTier (synced to audio)</div>
    <p class="muted" style="margin-top:0">Pure <b>vanilla JS + SVG</b> (no CDN). Files must be at repo root: <code>pitch.PitchTier</code>, <code>voice.mp3</code>, <code>humming.mp3</code>. Play either audio; the <span style="color:var(--danger)">red bar</span> tracks time. Override names with <code>?pitch=…&voice=…&hum=…</code>.</p><div class="grid" style="margin-top:16px">
  <div class="card">
    <div class="row" style="gap:16px;align-items:center">
      <button id="btnReset">⏮️ Reset</button>
      <button id="btnPlayVoice">▶️ Play voice</button>
      <button id="btnPlayHum">▶️ Play humming</button>
      <button id="btnPause">⏸️ Pause</button>
      <div class="grow"></div>
      <span class="pill" id="timepill">-- / -- s</span>
    </div>
    <div class="row" style="gap:16px;margin-top:10px">
      <label>Cursor offset (s)
        <input id="offset" type="number" step="0.05" value="0" />
      </label>
      <div class="grow"></div>
      <label class="muted">Seek</label>
      <input id="seek" type="range" min="0" max="0" step="0.01" value="0" />
    </div>
    <p id="status" class="muted" style="margin:10px 0 0"></p>
  </div>

  <div class="card">
    <div class="row" style="gap:16px;align-items:flex-start">
      <div class="grow">
        <div class="muted" style="font-size:13px;margin-bottom:6px">Player: audio 1 (voice) · <span id="vpath"></span></div>
        <audio id="voice" preload="auto" controls style="width:100%"></audio>
      </div>
      <div class="grow">
        <div class="muted" style="font-size:13px;margin-bottom:6px">Player: audio 2 (humming) · <span id="hpath"></span></div>
        <audio id="hum" preload="auto" controls style="width:100%"></audio>
      </div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:16px">
  <svg id="chart" viewBox="0 0 1000 400" preserveAspectRatio="none">
    <g id="axes" class="axis"></g>
    <path id="f0path" d="" fill="none" stroke="var(--accent)" stroke-width="2" />
    <line id="cursor" x1="0" y1="0" x2="0" y2="400" stroke="var(--danger)" stroke-width="2"/>
  </svg>
</div>

<p class="muted" style="margin-top:12px">Tip: use <b>Ctrl/Cmd+Shift+R</b> to bypass cache after updates.</p>

  </div>  <script>
  const $ = (id)=>document.getElementById(id);
  const qp = (k, def)=>{ const v=new URLSearchParams(location.search).get(k); return (v&&v.trim())||def; };

  function parsePitchTier(text){
    const f = s => s ? parseFloat(s) : NaN;
    const xmin = (text.match(/xmin\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/)||[])[1];
    const xmax = (text.match(/xmax\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/)||[])[1];
    const times = [...text.matchAll(/\bnumber\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/g)].map(m=>f(m[1]));
    const vals  = [...text.matchAll(/\bvalue\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/g)].map(m=>f(m[1]));
    const pts=[]; const n=Math.min(times.length, vals.length);
    for(let i=0;i<n;i++){ const t=times[i], v=vals[i]; if(Number.isFinite(t)&&Number.isFinite(v)) pts.push({t, f0:v}); }
    pts.sort((a,b)=>a.t-b.t);
    return { pts, xmin: xmin?+xmin: (pts[0]?.t ?? 0), xmax: xmax?+xmax: (pts.at(-1)?.t ?? 1) };
  }

  (async function main(){
    const pitchPath = qp('pitch','pitch.PitchTier');
    const voicePath = qp('voice','voice.mp3');
    const humPath   = qp('hum','humming.mp3');

    $('vpath').textContent = voicePath; $('hpath').textContent = humPath;
    $('voice').src = voicePath; $('hum').src = humPath;

    const statusEl = $('status');

    let pts=[], xmin=0, xmax=1;
    try{
      statusEl.textContent = 'Loading PitchTier…';
      const txt = await fetch(pitchPath,{cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('not found: '+pitchPath); return r.text();});
      ({pts, xmin, xmax} = parsePitchTier(txt));
      statusEl.textContent = `Loaded ${pts.length} points • ${xmin.toFixed(2)}–${xmax.toFixed(2)} s`;
    }catch(e){
      statusEl.textContent = 'Error loading PitchTier: '+e.message;
    }

    const svg = $('chart');
    const axes = $('axes');
    const path = $('f0path');
    const vb = svg.viewBox.baseVal;
    const W=vb.width,H=vb.height, padL=60,padR=20,padT=20,padB=30; const IW=W-padL-padR, IH=H-padT-padB;

    const ys = pts.map(p=>p.f0); const minY=Math.min(...ys), maxY=Math.max(...ys); const ypad=(maxY-minY)*0.1||10; const y0=Math.max(0,minY-ypad), y1=maxY+ypad;

    let scaleX = (t)=> padL + ((t-xmin)/(xmax-xmin))*IW;
    let scaleY = (y)=> padT + (1-((y-y0)/(y1-y0)))*IH;

    function line(x1,y1,x2,y2){ const el=document.createElementNS('http://www.w3.org/2000/svg','line'); el.setAttribute('x1',x1);el.setAttribute('y1',y1);el.setAttribute('x2',x2);el.setAttribute('y2',y2);el.setAttribute('stroke','#2a2e36'); return el; }
    axes.appendChild(line(padL,H-padB,W-padR,H-padB));
    axes.appendChild(line(padL,padT,padL,H-padB));
    const xt=10, yt=6;
    for(let i=0;i<=xt;i++){ const t = xmin + (i/xt)*(xmax-xmin); const x = scaleX(t); axes.appendChild(line(x,H-padB,x,H-padB+6)); const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',x); tx.setAttribute('y',H-8); tx.setAttribute('text-anchor','middle'); tx.setAttribute('fill','var(--muted)'); tx.textContent = t.toFixed(1)+'s'; axes.appendChild(tx);}    
    for(let i=0;i<=yt;i++){ const vy = y0 + (i/yt)*(y1-y0); const y=scaleY(vy); axes.appendChild(line(padL-6,y,padL,y)); const ty=document.createElementNS('http://www.w3.org/2000/svg','text'); ty.setAttribute('x',8); ty.setAttribute('y',y+4); ty.setAttribute('fill','var(--muted)'); ty.textContent = Math.round(vy); axes.appendChild(ty);}    

    const d = pts.map((p,i)=> (i?'L':'M')+scaleX(p.t)+' '+scaleY(p.f0)).join(' ');
    path.setAttribute('d', d);

    const cursor = $('cursor'); cursor.setAttribute('y1', padT); cursor.setAttribute('y2', H-padB);

    const v=$('voice'), h=$('hum'), seek=$('seek'), pill=$('timepill'), offEl=$('offset');
    function updatePill(){ pill.textContent = `${isFinite(v.currentTime)?v.currentTime.toFixed(2):'--'} / ${isFinite(v.duration)?v.duration.toFixed(2):'--'} s`; }
    function setAllTime(sec){ if(isFinite(sec)){ v.currentTime=sec; h.currentTime=sec; seek.value=String(sec); updateCursor(); updatePill(); } }
    function updateCursor(){ const off=parseFloat(offEl.value||'0')||0; const master = (!v.paused?v:h); const t = (master.currentTime||0)+off; const x = scaleX(Math.min(Math.max(xmin,t),xmax)); cursor.setAttribute('x1',x); cursor.setAttribute('x2',x); }

    v.addEventListener('loadedmetadata',()=>{ seek.max=String(v.duration||0); updatePill(); });
    h.addEventListener('loadedmetadata',()=>{ if(!+seek.max) seek.max=String(h.duration||0); updatePill(); });

    v.addEventListener('timeupdate',()=>{ if(!v.paused){ h.currentTime=v.currentTime; seek.value=String(v.currentTime); updateCursor(); updatePill(); }});
    h.addEventListener('timeupdate',()=>{ if(!h.paused){ v.currentTime=h.currentTime; seek.value=String(h.currentTime); updateCursor(); updatePill(); }});

    $('btnPlayVoice').onclick=()=>{ v.play(); h.play(); };
    $('btnPlayHum').onclick=()=>{ h.play(); v.play(); };
    $('btnPause').onclick=()=>{ v.pause(); h.pause(); };
    $('btnReset').onclick=()=> setAllTime(0);
    seek.oninput=(e)=> setAllTime(parseFloat(e.target.value));
    offEl.oninput=updateCursor;

    (function raf(){ updateCursor(); requestAnimationFrame(raf); })();
  })();
  </script></body>
</html>