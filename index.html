<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waveform visualiser – dual audio (vanilla JS, no CDN)</title>
  <style>
    :root{--bg:#0b0c0f;--ink:#e7e9ee;--muted:#9aa3b2;--panel:#14161a;--accent:#6ae2ff;--accent2:#8b7cff;--danger:#ff6b6b}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .h1{font-weight:700;font-size:26px;margin:0 0 6px}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px 18px;box-shadow:0 12px 28px rgba(0,0,0,.25)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}
    input[type=number], input[type=range]{background:#0f1218;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:10px;padding:8px 10px}
    input[type=range]{width:100%}
    button{background:#0f1218;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:999px;padding:8px 14px;cursor:pointer}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1218;border:1px solid rgba(255,255,255,.12);font-size:12px;color:var(--muted)}
    canvas{display:block;width:100%;height:260px;border-radius:10px;background:linear-gradient(#0f1218,#0f1218) padding-box,linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.06)) border-box;border:1px solid rgba(255,255,255,.08)}
    .legend{display:flex;gap:14px;align-items:center;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">Interactive waveform (synced to audio)</div>
    <p class="muted" style="margin-top:0">No dependencies. Files must be at repo root: <code>voice.mp3</code> & <code>humming.mp3</code>. Play either audio; the <span style="color:var(--danger)">red bar</span> tracks time. You can override names with <code>?voice=…&hum=…</code>.</p><div class="grid" style="margin-top:16px">
  <div class="card">
    <div class="row" style="gap:16px;align-items:center">
      <button id="btnReset">⏮️ Reset</button>
      <button id="btnPlayVoice">▶️ Play voice</button>
      <button id="btnPlayHum">▶️ Play humming</button>
      <button id="btnPause">⏸️ Pause</button>
      <div class="grow"></div>
      <span class="pill" id="timepill">-- / -- s</span>
    </div>
    <div class="row" style="gap:16px;margin-top:10px">
      <label>Cursor offset (ms)
        <input id="offset" type="number" step="5" value="0" />
      </label>
      <div class="grow"></div>
      <label class="muted">Seek</label>
      <input id="seek" type="range" min="0" max="0" step="0.01" value="0" />
    </div>
    <div class="legend">
      <span class="dot" style="background:var(--accent)"></span><span class="muted">Voice</span>
      <span class="dot" style="background:var(--accent2)"></span><span class="muted">Humming</span>
      <span class="dot" style="background:var(--danger)"></span><span class="muted">Playhead</span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="gap:16px;align-items:flex-start">
      <div class="grow">
        <div class="muted" style="font-size:13px;margin-bottom:6px">Player: audio 1 (voice) · <span id="vpath"></span></div>
        <audio id="voice" preload="auto" controls style="width:100%"></audio>
      </div>
      <div class="grow">
        <div class="muted" style="font-size:13px;margin-bottom:6px">Player: audio 2 (humming) · <span id="hpath"></span></div>
        <audio id="hum" preload="auto" controls style="width:100%"></audio>
      </div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:16px">
  <canvas id="wave"></canvas>
</div>

<p class="muted" style="margin-top:12px">Tip: use <b>Ctrl/Cmd+Shift+R</b> to bypass cache after updates. If your files differ slightly in length, use the offset to micro‑sync.</p>

  </div>  <script>
  // ---------- helpers ----------
  const $ = (id)=>document.getElementById(id);
  const qp = (k, def)=>{ const v=new URLSearchParams(location.search).get(k); return (v&&v.trim())||def; };

  // Downsampled min/max waveform for efficiency
  function buildWaveform(channelData, width){
    const N = channelData.length;
    const step = Math.ceil(N / width);
    const peaks = new Float32Array(width*2); // [min,max] pairs
    for(let i=0;i<width;i++){
      const start = i*step;
      const end = Math.min(start+step, N);
      let min=1e9, max=-1e9;
      for(let j=start;j<end;j++){ const s=channelData[j]; if(s<min)min=s; if(s>max)max=s; }
      peaks[i*2] = isFinite(min)?min:0; peaks[i*2+1]=isFinite(max)?max:0;
    }
    return peaks;
  }

  function drawWave(ctx, peaks, color, W, H){
    const mid = H/2; ctx.lineWidth = 1; ctx.strokeStyle = color; ctx.beginPath();
    for(let x=0;x<peaks.length/2;x++){
      const min = peaks[x*2], max = peaks[x*2+1];
      const y1 = mid + min*mid; const y2 = mid + max*mid;
      ctx.moveTo(x+0.5, y1); ctx.lineTo(x+0.5, y2);
    }
    ctx.stroke();
  }

  (async function main(){
    const voicePath = qp('voice','voice.mp3');
    const humPath   = qp('hum','humming.mp3');
    $('vpath').textContent = voicePath; $('hpath').textContent = humPath;
    $('voice').src = voicePath; $('hum').src = humPath;

    const canvas = $('wave');
    const ctx = canvas.getContext('2d');

    function resize(){ const dpr = Math.max(1, window.devicePixelRatio||1); const cssW = canvas.clientWidth||1000; const cssH = canvas.clientHeight||260; canvas.width = Math.floor(cssW*dpr); canvas.height = Math.floor(cssH*dpr); ctx.setTransform(dpr,0,0,dpr,0,0); render(); }
    window.addEventListener('resize', resize);

    let vBuf=null, hBuf=null, vPeaks=null, hPeaks=null, duration=0;

    async function decode(url){
      const ac = new (window.AudioContext||window.webkitAudioContext)();
      const ab = await fetch(url, {cache:'no-store'}).then(r=>r.arrayBuffer());
      const buf = await ac.decodeAudioData(ab);
      ac.close();
      return buf;
    }

    function preparePeaks(){
      const W = Math.max(600, canvas.clientWidth||1000); // pixel width to sample
      if(vBuf && (!vPeaks || vPeaks.length/2!==W)) vPeaks = buildWaveform(vBuf.getChannelData(0), W);
      if(hBuf && (!hPeaks || hPeaks.length/2!==W)) hPeaks = buildWaveform(hBuf.getChannelData(0), W);
    }

    function render(){
      const W = canvas.width; const H = canvas.height; // already in device pixels but ctx is scaled back
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = '#0f1218'; ctx.fillRect(0,0,W,H);
      // center line
      ctx.strokeStyle = 'rgba(255,255,255,.08)'; ctx.beginPath(); ctx.moveTo(0,H/2); ctx.lineTo(W,H/2); ctx.stroke();
      // grid light
      for(let i=1;i<6;i++){ const y = (H/2) + i*(H/12); ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); ctx.beginPath(); const y2=(H/2)-i*(H/12); ctx.moveTo(0,y2); ctx.lineTo(W,y2); ctx.stroke(); }
      // waves
      if(vPeaks) drawWave(ctx, vPeaks, 'rgba(106,226,255,0.95)', W, H);
      if(hPeaks) drawWave(ctx, hPeaks, 'rgba(139,124,255,0.75)', W, H);
      // cursor
      const offMs = parseFloat($('offset').value||'0')||0;
      const master = (!voice.paused? voice : hum);
      const t = (master.currentTime*1000 + offMs)/1000; // seconds
      const dur = duration || master.duration || 1;
      const x = Math.max(0, Math.min(W-1, Math.round((t/dur) * (W-1))));
      ctx.strokeStyle = 'rgba(255,107,107,1)'; ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,H); ctx.stroke();
    }

    // Load & draw
    try{ vBuf = await decode(voicePath); }catch(e){ console.warn('voice decode error', e); }
    try{ hBuf = await decode(humPath); }catch(e){ console.warn('hum decode error', e); }
    duration = Math.max(vBuf?.duration||0, hBuf?.duration||0);
    resize(); preparePeaks(); render();

    // ----- players & sync -----
    const voice=$('voice'), hum=$('hum'), seek=$('seek'), pill=$('timepill');
    function updatePill(){ const m = (!voice.paused? voice : hum); pill.textContent = `${(m.currentTime||0).toFixed(2)} / ${(m.duration||duration||0).toFixed(2)} s`; }
    function setAll(sec){ voice.currentTime=sec; hum.currentTime=sec; seek.value=String(sec); render(); updatePill(); }

    voice.addEventListener('loadedmetadata',()=>{ seek.max=String(voice.duration||duration||0); updatePill(); });
    hum.addEventListener('loadedmetadata',()=>{ if(!(+seek.max)) seek.max=String(hum.duration||duration||0); updatePill(); });

    voice.addEventListener('timeupdate',()=>{ if(!voice.paused){ hum.currentTime=voice.currentTime; seek.value=String(voice.currentTime); updatePill(); } render(); });
    hum.addEventListener('timeupdate',()=>{ if(!hum.paused){ voice.currentTime=hum.currentTime; seek.value=String(hum.currentTime); updatePill(); } render(); });

    $('btnPlayVoice').onclick=()=>{ voice.play(); hum.play(); };
    $('btnPlayHum').onclick=()=>{ hum.play(); voice.play(); };
    $('btnPause').onclick=()=>{ voice.pause(); hum.pause(); };
    $('btnReset').onclick=()=> setAll(0);
    seek.oninput=(e)=> setAll(parseFloat(e.target.value));
    $('offset').oninput=render;

    // keep cursor smooth
    (function raf(){ render(); requestAnimationFrame(raf); })();
  })();
  </script></body>
</html>