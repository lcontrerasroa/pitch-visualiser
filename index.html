<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pitch visualiser – Praat PitchTier + dual audio (repo assets)</title>
  <style>
    :root{--bg:#0b0c0f;--ink:#e7e9ee;--muted:#9aa3b2;--panel:#14161a;--accent:#6ae2ff;--danger:#ff6b6b}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .h1{font-weight:700;font-size:26px;margin:0 0 6px}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px 18px;box-shadow:0 12px 28px rgba(0,0,0,.25)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}
    input[type=number]{background:#0f1218;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:10px;padding:8px 10px;width:120px}
    button{background:#0f1218;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:999px;padding:8px 14px;cursor:pointer}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1218;border:1px solid rgba(255,255,255,.12);font-size:12px;color:var(--muted)}
    .legend{display:flex;gap:12px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%}
    .fallback{padding:24px;text-align:center}
  </style>
</head>
<body>
  <div class="fallback">
    <h1 class="h1">Interactive PitchTier (loading…)</h1>
    <p class="muted">If this screen stays blank, your browser blocked a CDN. Try reloading or check the console (F12). The page will replace this message once scripts load.</p>
  </div>
  <div id="root"></div>  <!-- React + Recharts (CDN) with fallbacks and defer to avoid race conditions -->  <script defer src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>  <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>  <script defer src="https://unpkg.com/recharts/umd/Recharts.min.js" crossorigin></script>  <!-- Fallback Recharts CDN -->  <script defer src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js" crossorigin></script>  <script>
  window.addEventListener('load', function(){
    try {
      if (!window.React || !window.ReactDOM) {
        document.body.innerHTML = '<div class="wrap"><h1 class="h1">Error: React failed to load</h1><p class="muted">CDN blocked? Check your network / browser extensions.</p></div>';
        return;
      }
      if (!window.Recharts) {
        document.body.innerHTML = '<div class="wrap"><h1 class="h1">Error: Recharts failed to load</h1><p class="muted">CDN blocked? Try hard-refresh (Ctrl/Cmd+Shift+R). If it persists, we can ship a no-dependency SVG version.</p></div>';
        return;
      }

      const { useEffect, useMemo, useRef, useState } = React;
      const { ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ReferenceLine, Scatter, Brush } = Recharts;

      function getParam(name, fallback){
        const p = new URLSearchParams(location.search).get(name);
        return (p && p.trim()) || fallback;
      }
      function parsePitchTier(text){
        const f = s => s ? parseFloat(s) : NaN;
        const xmin = (text.match(/xmin\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/)||[])[1];
        const xmax = (text.match(/xmax\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]\d+)?)/)||[])[1];
        const times = [...text.matchAll(/\bnumber\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/g)].map(m=>f(m[1]));
        const vals  = [...text.matchAll(/\bvalue\s*=\s*([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/g)].map(m=>f(m[1]));
        const pts=[]; const n=Math.min(times.length, vals.length);
        for(let i=0;i<n;i++){ const t=times[i], v=vals[i]; if(Number.isFinite(t)&&Number.isFinite(v)) pts.push({t:t,f0:v}); }
        pts.sort((a,b)=>a.t-b.t);
        const _xmin = xmin? parseFloat(xmin) : (pts[0]?.t ?? 0);
        const _xmax = xmax? parseFloat(xmax) : (pts[pts.length-1]?.t ?? 1);
        return {pts,xmin:_xmin,xmax:_xmax};
      }

      function App(){
        const pitchPath = getParam('pitch','pitch.PitchTier');
        const voicePath = getParam('voice','voice.mp3');
        const humPath   = getParam('hum','humming.mp3');

        const [pitchPts,setPitchPts] = useState([]);
        const [xmin,setXmin] = useState(null); const [xmax,setXmax]=useState(null);
        const [ymin,setYmin] = useState(null); const [ymax,setYmax]=useState(null);
        const [offset,setOffset] = useState(0);
        const [duration,setDuration] = useState(0);
        const [t,setT] = useState(0);
        const [err,setErr] = useState(null);

        const voiceRef = useRef(null);
        const humRef   = useRef(null);
        const rafRef   = useRef(0);
        const [syncPlayers,setSyncPlayers] = useState(true);

        useEffect(()=>{
          fetch(pitchPath, { cache: 'no-store' }).then(r=>{
            if(!r.ok) throw new Error('PitchTier not found: '+pitchPath);
            return r.text();
          }).then(txt=>{
            const {pts,xmin,xmax} = parsePitchTier(txt);
            setPitchPts(pts); setXmin(xmin); setXmax(xmax);
            if(pts.length){
              const ys = pts.map(p=>p.f0); const minY = Math.min(...ys); const maxY = Math.max(...ys); const pad=(maxY-minY)*0.1||10;
              setYmin(Math.max(0,minY-pad)); setYmax(maxY+pad);
            }
          }).catch(e=> setErr(e.message));
        },[pitchPath]);

        useEffect(()=>{
          const v=voiceRef.current, h=humRef.current; if(!v && !h) return;
          function onLoaded(){ setDuration((v?.duration||h?.duration||0)); }
          v&&v.addEventListener('loadedmetadata',onLoaded);
          h&&h.addEventListener('loadedmetadata',onLoaded);
          const loop = ()=>{
            const master = (v && !v.paused) ? v : ((h && !h.paused) ? h : (v||h));
            if(master){
              const ct = master.currentTime; setT(ct);
              if(syncPlayers){
                if(v && master!==v && Math.abs(v.currentTime-ct)>0.04) v.currentTime=ct;
                if(h && master!==h && Math.abs(h.currentTime-ct)>0.04) h.currentTime=ct;
              }
            }
            rafRef.current = requestAnimationFrame(loop);
          }
          rafRef.current = requestAnimationFrame(loop);
          return ()=> cancelAnimationFrame(rafRef.current);
        },[voiceRef.current, humRef.current, syncPlayers]);

        function play(target){ const v=voiceRef.current, h=humRef.current; if(!v||!h) return; if(target==='voice'){v.play(); if(syncPlayers) h.play();} else {h.play(); if(syncPlayers) v.play();} }
        function pauseAll(){ const v=voiceRef.current, h=humRef.current; v&&v.pause(); h&&h.pause(); }
        function seekAll(sec){ const v=voiceRef.current, h=humRef.current; if(v) v.currentTime=sec; if(h) h.currentTime=sec; setT(sec); }

        const data = React.useMemo(()=> pitchPts.map(p=>({time:p.t, f0:p.f0})), [pitchPts]);

        return React.createElement('div',{className:'wrap'},[
          React.createElement('div',{key:'hdr'},[
            React.createElement('div',{className:'h1'},'Interactive PitchTier (synced to audio)'),
            React.createElement('p',{className:'muted'},'Files are loaded from this repository. Use either player below; the red cursor tracks time over F0.'),
          ]),

          React.createElement('div',{key:'grid',className:'grid',style:{marginTop:16}},[
            React.createElement('div',{key:'a',className:'card'},[
              React.createElement('div',{className:'row',style:{gap:16,alignItems:'center'}},[
                React.createElement('button',{onClick:()=>seekAll(0)},'⏮️ Reset'),
                React.createElement('button',{onClick:()=>play('voice')},'▶️ Play voice'),
                React.createElement('button',{onClick:()=>play('hum')},'▶️ Play humming'),
                React.createElement('button',{onClick:pauseAll},'⏸️ Pause'),
                React.createElement('div',{className:'grow'}),
                React.createElement('span',{className:'pill'}, `${isFinite(t)?t.toFixed(2):'--'} / ${isFinite(duration)?duration.toFixed(2):'--'} s`),
              ]),
              React.createElement('div',{className:'row',style:{marginTop:10,gap:16}},[
                React.createElement('label',null,'Cursor offset (s)'),
                React.createElement('input',{type:'number',step:'0.05',value:offset,onChange:e=>setOffset(parseFloat(e.target.value)||0)}),
                React.createElement('div',{className:'grow'}),
                pitchPts.length?null:React.createElement('span',{className:'pill'},'Loading PitchTier…'),
                err?React.createElement('span',{className:'pill',style:{color:'#ff9aa2'}},String(err)):null,
              ]),
            ]),

            React.createElement('div',{key:'b',className:'card'},[
              React.createElement('div',{className:'row',style:{gap:16,alignItems:'flex-start'}},[
                React.createElement('div',{className:'grow'},[
                  React.createElement('div',null,[React.createElement('div',{className:'muted',style:{fontSize:13,marginBottom:6}},`Player: audio 1 (voice) · ${voicePath}`)]),
                  React.createElement('audio',{ref:voiceRef,src:voicePath,preload:'auto',controls:true,style:{width:'100%'}})
                ]),
                React.createElement('div',{className:'grow'},[
                  React.createElement('div',null,[React.createElement('div',{className:'muted',style:{fontSize:13,marginBottom:6}},`Player: audio 2 (humming) · ${humPath}`)]),
                  React.createElement('audio',{ref:humRef,src:humPath,preload:'auto',controls:true,style:{width:'100%'}})
                ])
              ])
            ])
          ]),

          React.createElement('div',{key:'chart',className:'card',style:{marginTop:16}},[
            React.createElement('div',{style:{height:380}},[
              React.createElement(ResponsiveContainer,{width:'100%',height:'100%'},[
                React.createElement(LineChart,{data:data,margin:{top:10,right:20,left:10,bottom:10}},[
                  React.createElement(CartesianGrid,{strokeDasharray:'3 3',stroke:'#2a2e36'}),
                  React.createElement(XAxis,{type:'number',dataKey:'time',domain:[xmin??'auto',xmax??'auto'],tick:{fill:'#9aa3b2'},tickFormatter:(v)=>Number(v).toFixed(1)+'s',stroke:'#454a53'}),
                  React.createElement(YAxis,{type:'number',domain:[ymin??'auto',ymax??'auto'],tick:{fill:'#9aa3b2'},tickFormatter:(v)=>Number(v).toFixed(0),stroke:'#454a53',label:{value:'F0 (Hz)',angle:-90,position:'insideLeft',fill:'#9aa3b2'}}),
                  React.createElement(Tooltip,{contentStyle:{background:'#0f1218',border:'1px solid #2a2e36',color:'#e7e9ee'},formatter:(v)=>Number(v).toFixed(1)+' Hz',labelFormatter:(v)=>Number(v).toFixed(3)+' s'}),
                  React.createElement(Line,{type:'monotone',dataKey:'f0',dot:false,stroke:'#6ae2ff',strokeWidth:2}),
                  React.createElement(Scatter,{dataKey:'f0',fill:'#667085'}),
                  React.createElement(ReferenceLine,{x:function(){return (t + offset);}(),stroke:'#ff6b6b',strokeWidth:2}),
                  React.createElement(Brush,{dataKey:'time',height:24,travellerWidth:8,stroke:'#6ae2ff'})
                ])
              ])
            ])
          ]),

          React.createElement('p',{className:'muted',style:{marginTop:12}},'Tip: files must exist at repo root: pitch.PitchTier, voice.mp3, humming.mp3. To bypass cache after updates, add ?v=2 to the URL or use Ctrl/Cmd+Shift+R.')
        ]);
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    } catch (e) {
      document.body.innerHTML = '<div class="wrap"><h1 class="h1">Runtime error</h1><pre style="white-space:pre-wrap" class="muted">'+String(e)+'</pre></div>';}

}); </script>

</body>
</html>