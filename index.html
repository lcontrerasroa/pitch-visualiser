<script src="./wavesurfer.min.js"></script>
<script>
(function(){
  const qp=(k,d)=>new URLSearchParams(location.search).get(k)||d;
  const src=qp('voice','voice.mp3');
  const featPath=qp('feat','features.json');
  const pitchPath=qp('pitch','pitch.PitchTier');

  // wavesurfer (overview + detail)
  const wsOverview=WaveSurfer.create({container:'#overview',height:72,waveColor:'#24313b',progressColor:'#435564',
    cursorColor:'transparent',barWidth:1,barGap:0,normalize:true,interact:true,dragToSeek:true,responsive:true});
  let pxPerSec=160;
  const wsDetail=WaveSurfer.create({container:'#detail',height:180,waveColor:'#2b97ad',progressColor:'#6ae2ff',cursorColor:'#6ae2ff',
    barWidth:2,barGap:1,minPxPerSec:pxPerSec,autoCenter:true,hideScrollbar:false,dragToSeek:true,normalize:true,responsive:true});
  wsOverview.load(src); wsDetail.load(src);

  // controls
  const timePill=document.getElementById('time');
  document.getElementById('zoomIn').onclick = ()=>{ pxPerSec=Math.min(800,pxPerSec*1.25); wsDetail.setOptions({minPxPerSec:pxPerSec}); drawPitch(); };
  document.getElementById('zoomOut').onclick= ()=>{ pxPerSec=Math.max(40, pxPerSec/1.25); wsDetail.setOptions({minPxPerSec:pxPerSec}); drawPitch(); };
  document.getElementById('play').onclick   = ()=> wsDetail.play();
  document.getElementById('pause').onclick  = ()=> wsDetail.pause();
  function syncOverview(){ const t=wsDetail.getCurrentTime()||0, d=wsDetail.getDuration()||1; if(wsOverview.setTime) wsOverview.setTime(t); else wsOverview.seekTo(t/d); }
  wsDetail.on('timeupdate',()=>{ syncOverview(); const t=wsDetail.getCurrentTime()||0, d=wsDetail.getDuration()||0; timePill.textContent=`${t.toFixed(2)} / ${d.toFixed(2)} s`; drawPitch(); });
  wsDetail.on('seek',()=>{ syncOverview(); drawPitch(); });
  wsOverview.on('seek',rel=> wsDetail.seekTo(rel));
  wsDetail.on('redraw',()=>{ resizePitch(); drawPitch(); });
  window.addEventListener('resize',()=>{ resizePitch(); drawPitch(); });

  // overlay canvas (F0 left axis + RMS right axis)
  const pitchCanvas=document.getElementById('pitch'), pctx=pitchCanvas.getContext('2d');
  const cssVar=(name,fallback)=>getComputedStyle(document.documentElement).getPropertyValue(name).trim()||fallback;
  function resizePitch(){ const dpr=Math.max(1,devicePixelRatio||1);
    const rect=wsDetail.getWrapper().getBoundingClientRect();
    pitchCanvas.width=Math.max(1,Math.floor(rect.width*dpr)); const cssH=160; pitchCanvas.height=Math.floor(cssH*dpr);
    pitchCanvas.style.width=rect.width+'px'; pitchCanvas.style.height=cssH+'px'; pctx.setTransform(dpr,0,0,dpr,0,0); }
  resizePitch();

  let f0pts=null, rmsPts=null, rmsMax=1;

  async function tryLoadFeaturesJSON(){
    try{ const r=await fetch(featPath,{cache:'no-store'}); if(!r.ok) return false;
      const data=await r.json();
      const f0=(data.f0||data.points||[]).map(v=>Array.isArray(v)?{t:+v[0],f0:+v[1]}:({t:+v.t,f0:+v.f0}));
      const rms=(data.rms||[]).map(v=>Array.isArray(v)?{t:+v[0],r:+v[1]}:({t:+v.t,r:+v.r}));
      if(f0.length) f0pts=f0; if(rms.length) { rmsPts=rms; rmsMax=Math.max(1, ...rms.map(p=>p.r)); }
      if(f0.length||rms.length){ drawPitch(); return true; } return false;
    }catch{ return false; }
  }
  function parsePitchTier(text){
    const f=s=>s?parseFloat(s):NaN;
    const ts=[...text.matchAll(/\\bnumber\\s*=\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)/g)].map(m=>f(m[1]));
    const vs=[...text.matchAll(/\\bvalue\\s*=\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)/g)].map(m=>f(m[1]));
    const out=[]; for(let i=0;i<Math.min(ts.length,vs.length);i++){ const t=ts[i], v=vs[i]; if(Number.isFinite(t)&&Number.isFinite(v)) out.push({t,f0:v}); }
    return out.sort((a,b)=>a.t-b.t);
  }
  async function tryLoadPitchTier(){
    try{ const r=await fetch(pitchPath,{cache:'no-store'}); if(!r.ok) return false;
      const txt=await r.text(); const arr=parsePitchTier(txt); if(!arr.length) return false; f0pts=arr; drawPitch(); return true;
    }catch{ return false; }
  }

  // fallback (only if both files missing): compute quickly
  async function computeFeatures(){ /* unchanged from before; safe to leave out if you precompute */ }

  (async()=>{
    if(await tryLoadFeaturesJSON()) return;
    if(await tryLoadPitchTier())   return;
    // fallback: compute on first play/ready
    let armed=false; const arm=()=>{ if(!armed){ armed=true; computeFeatures(); } };
    wsDetail.on('ready',arm); wsDetail.on('play',arm);
    document.getElementById('play').addEventListener('click',arm);
    document.documentElement.addEventListener('touchend',arm,{once:true});
    setTimeout(arm,1200);
  })();

  function drawPitch(){
    const W=pitchCanvas.width, H=pitchCanvas.height; if(!W||!H) return; pctx.clearRect(0,0,W,H);
    pctx.strokeStyle='rgba(255,255,255,.06)'; for(let i=1;i<=3;i++){ const y=(H*i/4); pctx.beginPath(); pctx.moveTo(0,y+0.5); pctx.lineTo(W,y+0.5); pctx.stroke(); }
    const dur=wsDetail.getDuration()||1, widthPx=pitchCanvas.clientWidth||W, secondsVisible=widthPx/pxPerSec;
    const cur=wsDetail.getCurrentTime()||0, start=Math.max(0, Math.min(cur - secondsVisible/2, Math.max(0,dur-secondsVisible)));

    if(f0pts && f0pts.length){
      const fmin=(qp('fmin',60)|0)||60, fmax=(qp('fmax',400)|0)||400;
      pctx.strokeStyle=cssVar('--accent','#4be4ff'); pctx.lineWidth=3; pctx.beginPath(); let on=false;
      for(const p of f0pts){ if(p.t<start||p.t>start+secondsVisible||p.f0<=0){ on=false; continue; }
        const x=(p.t-start)*pxPerSec; const ratio=Math.max(0,Math.min(1,(p.f0-fmin)/(fmax-fmin))); const y=H - ratio*H;
        if(!on){ pctx.moveTo(x,y); on=true; } else { pctx.lineTo(x,y); } }
      pctx.stroke();
    }
    if(rmsPts && rmsPts.length){
      pctx.strokeStyle=cssVar('--rms','#a6ff6a'); pctx.lineWidth=1.5; pctx.beginPath(); let on=false; const maxV=rmsMax||1;
      for(const p of rmsPts){ if(p.t<start||p.t>start+secondsVisible){ on=false; continue; }
        const x=(p.t-start)*pxPerSec; const y=H - Math.min(1,(p.r/maxV))*H;
        if(!on){ pctx.moveTo(x,y); on=true; } else { pctx.lineTo(x,y); } }
      pctx.stroke();
    }
    const x=(secondsVisible/2)*pxPerSec; pctx.strokeStyle=cssVar('--cursor','#ff6b6b'); pctx.lineWidth=2; pctx.beginPath(); pctx.moveTo(x+0.5,0); pctx.lineTo(x+0.5,H); pctx.stroke();
  }
})();
</script>